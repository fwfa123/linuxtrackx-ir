Name "linuxtrack-wine"
OutFile "linuxtrack-wine.exe"
InstallDir $PROGRAMFILES\Linuxtrack
InstallDirRegKey HKLM "Software\Linuxtrack" "InstallDir"

Page components
Page directory
Page instfiles

UninstPage uninstConfirm
UninstPage instfiles

Function .onInit

  ReadRegStr $R0 HKLM \
  "Software\Microsoft\Windows\CurrentVersion\Uninstall\Linuxtrack" \
  "UninstallString"
  StrCmp $R0 "" done

  # Check if this is a reinstallation
  IfFileExists "$INSTDIR\NPClient.dll" 0 done
  
  MessageBox MB_YESNO|MB_ICONQUESTION \
  "Linuxtrack-Wine is already installed. $\n$\nClick `Yes` to upgrade the installation (existing DLL files will be preserved) or `No` to cancel." \
  IDYES done
  Abort

done:

FunctionEnd

Function BackupExistingFiles
  # Backup existing DLL files if they exist
  IfFileExists "$INSTDIR\NPClient.dll" 0 +3
    CopyFiles "$INSTDIR\NPClient.dll" "$INSTDIR\NPClient.dll.backup"
    DetailPrint "Backed up existing NPClient.dll"
  
  IfFileExists "$INSTDIR\FreeTrackClient.dll" 0 +3
    CopyFiles "$INSTDIR\FreeTrackClient.dll" "$INSTDIR\FreeTrackClient.dll.backup"
    DetailPrint "Backed up existing FreeTrackClient.dll"
FunctionEnd

Function RestoreBackupFiles
  # Restore backup files if installation failed
  IfFileExists "$INSTDIR\NPClient.dll.backup" 0 +3
    CopyFiles "$INSTDIR\NPClient.dll.backup" "$INSTDIR\NPClient.dll"
    DetailPrint "Restored NPClient.dll from backup"
  
  IfFileExists "$INSTDIR\FreeTrackClient.dll.backup" 0 +3
    CopyFiles "$INSTDIR\FreeTrackClient.dll.backup" "$INSTDIR\FreeTrackClient.dll"
    DetailPrint "Restored FreeTrackClient.dll from backup"
FunctionEnd

Section "Linuxtrack / TrackIR Interface"
  SectionIn RO
  SetOutPath $INSTDIR
  
  # Backup existing files before installation
  Call BackupExistingFiles
  
  File /oname=Controller.exe controller\Controller.exe.so
  File /oname=Tester.exe tester\Tester.exe.so
  File /oname=NPClient.dll client\NPClient.dll.so
  File /oname=check_data.exe client\check_data.exe.so
  File /oname=linuxtrack.ico @srcdir@\controller\linuxtrack.ico
  File /oname=TrackIR.exe views\TrackIR.exe.so
  
  # Remove backup files after successful installation
  Delete "$INSTDIR\NPClient.dll.backup"
  Delete "$INSTDIR\FreeTrackClient.dll.backup"
  
  WriteRegStr HKLM SOFTWARE\Linuxtrack "Install_dir" "$INSTDIR"
  WriteRegStr HKCU "Software\NaturalPoint\NATURALPOINT\NPClient Location" "Path" "$INSTDIR\"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Linuxtrack" "DisplayName" "Linuxtrack wine bridge"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Linuxtrack" "UninstallString" '"$INSTDIR\uninstall.exe"'
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Linuxtrack" "NoModify" 1
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Linuxtrack" "NoRepair" 1
  WriteUninstaller "uninstall.exe"
  Exec '"$INSTDIR\check_data.exe"'
SectionEnd

Section "Linuxtrack / Freetrack Interface"
  SetOutPath $INSTDIR
  File /oname=FreeTrackTester.exe ft_tester\ftc.exe.so
  File /oname=FreeTrackClient.dll ft_client\FreeTrackClient.dll.so
  WriteRegStr HKCU "Software\Freetrack\FreetrackClient" "Path" "$INSTDIR\"
SectionEnd

Section "Start Menu Shortcuts"
  CreateDirectory "$SMPROGRAMS\Linuxtrack"
  CreateShortCut "$SMPROGRAMS\Linuxtrack\Uninstall.lnk" "$INSTDIR\uninstall.exe" "" "$INSTDIR\uninstall.exe" 0
  CreateShortCut "$SMPROGRAMS\Linuxtrack\Controller.lnk" "$INSTDIR\Controller.exe" "" "$INSTDIR\linuxtrack.ico" 0
  CreateShortCut "$SMPROGRAMS\Linuxtrack\TrackIR.lnk" "$INSTDIR\TrackIR.exe" "" "$INSTDIR\linuxtrack.ico" 0
  CreateShortCut "$SMPROGRAMS\Linuxtrack\Tester.lnk" "$INSTDIR\Tester.exe" "" "$INSTDIR\Tester.exe"
  CreateShortCut "$SMPROGRAMS\Linuxtrack\FreeTrackTester.lnk" "$INSTDIR\FreeTrackTester.exe" "" "$INSTDIR\FreeTrackTester.exe"
SectionEnd

Section "Uninstall"
  DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Linuxtrack"
  DeleteRegKey HKLM SOFTWARE\Linuxtrack
  DeleteRegKey HKCU Software\NaturalPoint
  DeleteRegKey HKCU Software\Freetrack
  Delete $INSTDIR\Controller.exe
  Delete $INSTDIR\Tester.exe
  Delete $INSTDIR\NPClient.dll
  Delete $INSTDIR\FreeTrackClient.dll
  Delete $INSTDIR\FreeTrackTester.exe
  Delete $INSTDIR\uninstall.exe
  Delete $INSTDIR\check_data.exe
  Delete $INSTDIR\TrackIR.exe
  Delete $INSTDIR\linuxtrack.ico
  # Note: TIRViews.dll and mfc42u.dll are symlinks to files managed by LinuxTrack
  # Do not delete them as it would remove the actual source files
  # Delete $INSTDIR\TIRViews.dll
  # Delete $INSTDIR\mfc42u.dll
  Delete "$SMPROGRAMS\Linuxtrack\*.*"
  RMDir "$SMPROGRAMS\Linuxtrack"
  RMDir "$INSTDIR"
SectionEnd
