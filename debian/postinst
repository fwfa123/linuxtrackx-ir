#!/bin/bash

set -e

case "$1" in
    configure)
        # Reload udev rules for TrackIR devices
        echo "LinuxTrack: Setting up device access..."
        
        if command -v udevadm >/dev/null 2>&1; then
            udevadm control --reload-rules || true
            udevadm trigger || true
            echo "LinuxTrack: udev rules reloaded"
        else
            echo "LinuxTrack: Warning - udevadm not found, udev rules not reloaded"
        fi
        
        # Ensure plugdev group exists and is accessible
        if ! getent group plugdev >/dev/null; then
            echo "LinuxTrack: Warning - plugdev group not found"
            echo "LinuxTrack: You may need to create it: sudo groupadd plugdev"
        fi
        
        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database /usr/share/applications || true
            echo "LinuxTrack: Desktop database updated"
        fi
        
        # Update icon cache
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor || true
            echo "LinuxTrack: Icon cache updated"
        fi
        
        # Create symbolic links in /usr/bin for convenience
        ln -sf /opt/linuxtrack/bin/ltr_gui /usr/bin/ltr_gui || true
        ln -sf /opt/linuxtrack/bin/mickey /usr/bin/mickey || true
        ln -sf /opt/linuxtrack/bin/ltr_server1 /usr/bin/ltr_server1 || true
        ln -sf /opt/linuxtrack/bin/verify_installation.sh /usr/bin/linuxtrack-verify || true
        
        # Set up library path
        echo "/opt/linuxtrack/lib/linuxtrack" > /etc/ld.so.conf.d/linuxtrack.conf
        ldconfig || true
        
        echo ""
        echo "LinuxTrack installation completed!"
        echo ""
        echo "To use LinuxTrack:"
        echo "  1. Add your user to the plugdev group:"
        echo "     sudo usermod -a -G plugdev \$USER"
        echo "  2. Log out and log back in"
        echo "  3. Run: ltr_gui"
        echo ""
        echo "For troubleshooting: linuxtrack-verify"
        echo "Documentation: /usr/share/doc/linuxtrack/"
        echo ""
        ;;
        
    abort-upgrade|abort-remove|abort-deconfigure)
        ;;
        
    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#

exit 0 